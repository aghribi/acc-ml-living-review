{{ define "title" }}Browse the Living Review | {{ .Site.Title }}{{ end }}

{{ define "main" }}
{{ $data := .Site.Data.livingreview }}
{{ $stats := default dict $data.stats }}
{{ $papers := default (dict) $data.papers }}

<div class="page-header">
    <h1>Browse the Living Review</h1>
    <p class="page-subtitle">{{ len (default (dict) $papers) }}+ papers on AI/ML applications in particle accelerator science</p>
</div>

<!-- Sticky Search and View Toggle Bar -->
<div class="sticky-controls">
    <div class="container">
        <!-- Search Bar with Filters -->
        <div class="search-container">
            <div class="search-wrapper">
                <input type="text" class="filter-bar search-input" id="searchInput" 
                       placeholder="Search papers, authors, keywords...">
                <button class="btn btn-secondary filter-btn" onclick="toggleAdvancedFilters()">
                    <span>üîç</span> Filters
                </button>
            </div>
            
            <!-- Filter Row (Always Visible) -->
            <div class="filter-row-inline">
                <div class="filter-group-inline">
                    <label for="yearFilter">Year:</label>
                    <select id="yearFilter" class="filter-select">
                        <option value="">All Years</option>
                        {{ range seq 2025 -1 2010 }}
                        <option value="{{ . }}">{{ . }}</option>
                        {{ end }}
                    </select>
                </div>
                
                <div class="filter-group-inline">
                    <label for="venueFilter">Venue:</label>
                    <select id="venueFilter" class="filter-select">
                        <option value="">All Venues</option>
                        {{ range $venue, $count := index $stats "per_venue/journal" }}
                        <option value="{{ $venue }}">{{ $venue }}</option>
                        {{ end }}
                    </select>
                </div>
                
                <div class="filter-group-inline">
                    <label for="specialFilter">Other:</label>
                    <select id="specialFilter" class="filter-select">
                        <option value="">All Categories</option>
                        {{ range $category, $count := $stats.per_category }}
                        {{ $isByFacility := or (hasPrefix $category "by facility") (hasPrefix $category "By facility") (in $category "facility type") (in $category "Facility type") }}
                        {{ $isToolsOrMethods := or (in $category "Tools") (in $category "tools") (in $category "Methods") (in $category "methods") (eq $category "Reviews") (eq $category "Surveys") }}
                        {{ if or $isByFacility $isToolsOrMethods }}
                        <option value="{{ $category }}">{{ $category }}</option>
                        {{ end }}
                        {{ end }}
                    </select>
                </div>
                
                <button class="btn btn-reset" onclick="resetFilters()">
                    <span>‚úï</span> Reset
                </button>
            </div>
        </div>

        <!-- View Toggle -->
        <div class="view-toggle">
            <button class="view-btn active" data-view="both" onclick="setView('both')">
                Both
            </button>
            <button class="view-btn" data-view="statistics" onclick="setView('statistics')">
                <span>üìä</span> Statistics
            </button>
            <button class="view-btn" data-view="papers" onclick="setView('papers')">
                <span>üìÑ</span> Papers
            </button>
        </div>
    </div>
</div>

<div class="main-wrapper">
    <!-- Enhanced Table of Contents -->
    <aside class="toc" id="tocSidebar">
        <div class="toc-header">
            <h3>Categories</h3>
            <button class="toc-toggle" onclick="toggleTOC()" title="Toggle sidebar">‚ò∞</button>
        </div>
        
        <ul class="toc-list">
            <li class="toc-item">
                <a href="#statistics" class="toc-link" data-category="statistics">
                    <span class="toc-icon">üìä</span>
                    <span class="toc-label">Statistics & Trends</span>
                </a>
            </li>
            
            <li class="toc-item">
                <a href="#control" class="toc-link" data-category="control">
                    <span class="toc-dot" style="background-color: #6096ba;"></span>
                    <span class="toc-label">Control</span>
                    <span class="toc-count">0</span>
                </a>
            </li>
            
            <li class="toc-item">
                <a href="#optimization" class="toc-link" data-category="optimization">
                    <span class="toc-dot" style="background-color: #507a9a;"></span>
                    <span class="toc-label">Optimization</span>
                    <span class="toc-count">0</span>
                </a>
            </li>
            
            <li class="toc-item">
                <a href="#anomalies" class="toc-link" data-category="anomalies">
                    <span class="toc-dot" style="background-color: #8bc4e8;"></span>
                    <span class="toc-label">Anomalies</span>
                    <span class="toc-count">0</span>
                </a>
            </li>
            
            <li class="toc-item">
                <a href="#simulations" class="toc-link" data-category="simulations">
                    <span class="toc-dot" style="background-color: #4a6fa5;"></span>
                    <span class="toc-label">Simulations</span>
                    <span class="toc-count">0</span>
                </a>
            </li>
            
            <li class="toc-item">
                <a href="#novel-applications" class="toc-link" data-category="novel-applications">
                    <span class="toc-dot" style="background-color: #2e5266;"></span>
                    <span class="toc-label">Novel Applications</span>
                    <span class="toc-count">0</span>
                </a>
            </li>
            
            <li class="toc-item">
                <a href="#other-topics" class="toc-link" data-category="other-topics">
                    <span class="toc-dot" style="background-color: #6096ba;"></span>
                    <span class="toc-label">Other Topics</span>
                    <span class="toc-count">0</span>
                </a>
            </li>
        </ul>
        
        <!-- Quick Actions -->
        <div class="quick-actions">
            <h4>Quick Actions</h4>
            <button class="quick-action-btn" onclick="showAllPapers()">
                <span>üìã</span> Show All Papers
            </button>
            <button class="quick-action-btn" onclick="showRecentAdditions()">
                <span>üìÖ</span> Recent Additions
            </button>
            <button class="quick-action-btn" onclick="exportBibliography()">
                <span>‚¨áÔ∏è</span> Export Bibliography
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="content" id="mainContent">
        
        <!-- Latest Additions Section (not in TOC) -->
        <div class="section latest-additions-section" id="latest-additions" data-view-section="papers">
            <div class="section-header" onclick="toggleSection(this)">
                <h2 class="section-title">üìÖ Latest Additions (Last 30 Days)</h2>
                <span class="chevron">‚ñº</span>
            </div>
            <div class="section-body">
                {{ $thirtyDaysAgo := now.AddDate 0 0 -30 }}
                {{ $recentPapers := slice }}
                {{ range $papers }}
                    {{ $paperDate := .date }}
                    {{ $isRecent := false }}
                    {{ if $paperDate }}
                        {{ $parsedDate := time $paperDate }}
                        {{ if ge $parsedDate $thirtyDaysAgo }}
                            {{ $isRecent = true }}
                        {{ end }}
                    {{ else if or (eq .year "2025") (eq .year "2024") }}
                        {{ $isRecent = true }}
                    {{ end }}
                    
                    {{ if $isRecent }}
                        {{ $recentPapers = $recentPapers | append . }}
                    {{ end }}
                {{ end }}
                
                {{ range $recentPapers }}
                    {{ $paper := . }}
                    <div class="paper-item" 
                         data-paper-id="{{ $paper.id }}"
                         data-year="{{ $paper.year }}"
                         data-date="{{ with $paper.date }}{{ . }}{{ else }}{{ end }}"
                         data-venue="{{ $paper.venue }}"
                         data-title="{{ $paper.title }}"
                         data-authors="{{ delimit $paper.authors " " }}"
                         data-main-category="latest-additions"
                         data-all-categories="{{ range .categories }}{{ .label }}|{{ end }}">
                        {{ $paperUrl := "" }}
                        {{ if $paper.links.arxiv }}
                            {{ $paperUrl = $paper.links.arxiv }}
                        {{ else if $paper.links.inspire }}
                            {{ $paperUrl = $paper.links.inspire }}
                        {{ else if $paper.links.openalex }}
                            {{ $paperUrl = $paper.links.openalex }}
                        {{ else if $paper.doi }}
                            {{ $paperUrl = printf "https://doi.org/%s" $paper.doi }}
                        {{ end }}
                        
                        <a href="{{ $paperUrl }}" class="paper-title" target="_blank" rel="noopener noreferrer">{{ $paper.title }}</a>
                        <div class="paper-meta">
                            <span class="paper-authors">{{ delimit $paper.authors ", " }}</span>
                            <span>‚Ä¢</span>
                            <span class="paper-venue">{{ $paper.venue }} ({{ $paper.year }})</span>
                            {{ if $paper.doi }}
                            <span>‚Ä¢</span>
                            <span class="paper-doi">DOI: {{ $paper.doi }}</span>
                            {{ end }}
                        </div>

                        {{ if $paper.categories }}
                        <div class="paper-tags">
                          {{ range $paper.categories }}
                            <span class="tag">
                              {{ .label }}
                              {{ with .score }} ({{ printf "%.1f%%" (mul . 100) }}){{ end }}
                            </span>
                          {{ end }}
                        </div>
                        {{ end }}
                    </div>
                {{ end }}
            </div>
        </div>

        <!-- Statistics Section -->
        <div class="section statistics-section" id="statistics" data-view-section="statistics">
            <div class="section-header" onclick="toggleSection(this)">
                <h2 class="section-title">üìä Publication Statistics & Trends</h2>
                <span class="chevron">‚ñº</span>
            </div>
            <div class="section-body">
                <div class="charts-grid">
                    <!-- Chart 1: Publications per Year -->
                    <div class="chart-card">
                        <h3>Publication Trend Over Time</h3>
                        <canvas id="chart1"></canvas>
                    </div>

                    <!-- Chart 2: Papers by Category -->
                    <div class="chart-card">
                        <h3>Papers by Category</h3>
                        <canvas id="chart2"></canvas>
                    </div>

                    <!-- Chart 3: Recent Activity -->
                    <div class="chart-card">
                        <h3>Recent Activity (Last 6 Months)</h3>
                        <canvas id="chart3"></canvas>
                    </div>

                    <!-- Chart 4: Top Venues -->
                    <div class="chart-card">
                        <h3>Top Publication Venues</h3>
                        <canvas id="chart4"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Papers by Main Category Groups -->
        {{ $categoryGroups := dict 
            "control" (slice "Control" "Controls" "Feedback" "Tuning" "Operation" "Operations")
            "optimization" (slice "Optimization" "Optimisation" "Parameter" "Multi-Objective")
            "anomalies" (slice "Anomaly" "Fault" "Error" "Beam Loss" "Loss")
            "simulations" (slice "Simulation" "Surrogate" "Virtual" "Digital Twin" "Modeling" "Modelling")
            "novel-applications" (slice "Novel" "Emerging" "Advanced" "New Techniques")
        }}
        
        {{ range $groupId, $keywords := $categoryGroups }}
        <div class="section collapsed papers-section" id="{{ $groupId }}" data-view-section="papers" data-main-category="{{ $groupId }}">
            <div class="section-header" onclick="toggleSection(this)">
                <h2 class="section-title">{{ replace (replace $groupId "-" " ") "applications" "Applications" | title }}</h2>
                <span class="chevron">‚ñº</span>
            </div>
            <div class="section-body">
                {{ range $papers }}
                    {{ $paper := . }}
                    {{ $shouldShow := false }}
                    
                    {{ range .categories }}
                        {{ $cat := .label }}
                        {{ $isByFacility := or (hasPrefix $cat "by facility") (hasPrefix $cat "By facility") (in $cat "facility type") (in $cat "Facility type") }}
                        {{ $isToolsOrMethods := or (in $cat "Tools") (in $cat "tools") (in $cat "Methods") (in $cat "methods") (eq $cat "Reviews") (eq $cat "Surveys") }}
                        
                        {{ if not (or $isByFacility $isToolsOrMethods) }}
                            {{ range $keyword := $keywords }}
                                {{ if in $cat $keyword }}
                                    {{ $shouldShow = true }}
                                {{ end }}
                            {{ end }}
                        {{ end }}
                    {{ end }}
                    
                    {{ if $shouldShow }}
                    <div class="paper-item" 
                         data-paper-id="{{ $paper.id }}"
                         data-year="{{ $paper.year }}"
                         data-date="{{ with $paper.date }}{{ . }}{{ else }}{{ end }}"
                         data-venue="{{ $paper.venue }}"
                         data-title="{{ $paper.title }}"
                         data-authors="{{ delimit $paper.authors " " }}"
                         data-main-category="{{ $groupId }}"
                         data-all-categories="{{ range .categories }}{{ .label }}|{{ end }}">
                        {{ $paperUrl := "" }}
                        {{ if $paper.links.arxiv }}
                            {{ $paperUrl = $paper.links.arxiv }}
                        {{ else if $paper.links.inspire }}
                            {{ $paperUrl = $paper.links.inspire }}
                        {{ else if $paper.links.openalex }}
                            {{ $paperUrl = $paper.links.openalex }}
                        {{ else if $paper.doi }}
                            {{ $paperUrl = printf "https://doi.org/%s" $paper.doi }}
                        {{ end }}
                        
                        <a href="{{ $paperUrl }}" class="paper-title" target="_blank" rel="noopener noreferrer">{{ $paper.title }}</a>
                        <div class="paper-meta">
                            <span class="paper-authors">{{ delimit $paper.authors ", " }}</span>
                            <span>‚Ä¢</span>
                            <span class="paper-venue">{{ $paper.venue }} ({{ $paper.year }})</span>
                            {{ if $paper.doi }}
                            <span>‚Ä¢</span>
                            <span class="paper-doi">DOI: {{ $paper.doi }}</span>
                            {{ end }}
                        </div>

                        {{ if $paper.categories }}
                        <div class="paper-tags">
                          {{ range $paper.categories }}
                            <span class="tag">
                              {{ .label }}
                              {{ with .score }} ({{ printf "%.1f%%" (mul . 100) }}){{ end }}
                            </span>
                          {{ end }}
                        </div>
                        {{ end }}
                    </div>
                    {{ end }}
                {{ end }}
            </div>
        </div>
        {{ end }}
        
        <!-- Other Topics -->
        <div class="section collapsed papers-section" id="other-topics" data-view-section="papers" data-main-category="other-topics">
            <div class="section-header" onclick="toggleSection(this)">
                <h2 class="section-title">Other Topics</h2>
                <span class="chevron">‚ñº</span>
            </div>
            <div class="section-body">
                {{ range $papers }}
                    {{ $paper := . }}
                    {{ $isOther := true }}
                    
                    {{ range .categories }}
                        {{ $cat := .label }}
                        {{ $isByFacility := or (hasPrefix $cat "by facility") (hasPrefix $cat "By facility") (in $cat "facility type") (in $cat "Facility type") }}
                        {{ $isToolsOrMethods := or (in $cat "Tools") (in $cat "tools") (in $cat "Methods") (in $cat "methods") (eq $cat "Reviews") (eq $cat "Surveys") }}
                        
                        {{ if or $isByFacility $isToolsOrMethods }}
                            {{ $isOther = false }}
                        {{ end }}
                        
                        {{ range $groupId, $keywords := $categoryGroups }}
                            {{ range $keyword := $keywords }}
                                {{ if in $cat $keyword }}
                                    {{ $isOther = false }}
                                {{ end }}
                            {{ end }}
                        {{ end }}
                    {{ end }}
                    
                    {{ if $isOther }}
                    <div class="paper-item" 
                         data-paper-id="{{ $paper.id }}"
                         data-year="{{ $paper.year }}"
                         data-date="{{ with $paper.date }}{{ . }}{{ else }}{{ end }}"
                         data-venue="{{ $paper.venue }}"
                         data-title="{{ $paper.title }}"
                         data-authors="{{ delimit $paper.authors " " }}"
                         data-main-category="other-topics"
                         data-all-categories="{{ range .categories }}{{ .label }}|{{ end }}">
                        {{ $paperUrl := "" }}
                        {{ if $paper.links.arxiv }}
                            {{ $paperUrl = $paper.links.arxiv }}
                        {{ else if $paper.links.inspire }}
                            {{ $paperUrl = $paper.links.inspire }}
                        {{ else if $paper.links.openalex }}
                            {{ $paperUrl = $paper.links.openalex }}
                        {{ else if $paper.doi }}
                            {{ $paperUrl = printf "https://doi.org/%s" $paper.doi }}
                        {{ end }}
                        
                        <a href="{{ $paperUrl }}" class="paper-title" target="_blank" rel="noopener noreferrer">{{ $paper.title }}</a>
                        <div class="paper-meta">
                            <span class="paper-authors">{{ delimit $paper.authors ", " }}</span>
                            <span>‚Ä¢</span>
                            <span class="paper-venue">{{ $paper.venue }} ({{ $paper.year }})</span>
                            {{ if $paper.doi }}
                            <span>‚Ä¢</span>
                            <span class="paper-doi">DOI: {{ $paper.doi }}</span>
                            {{ end }}
                        </div>

                        {{ if $paper.categories }}
                        <div class="paper-tags">
                          {{ range $paper.categories }}
                            <span class="tag">
                              {{ .label }}
                              {{ with .score }} ({{ printf "%.1f%%" (mul . 100) }}){{ end }}
                            </span>
                          {{ end }}
                        </div>
                        {{ end }}
                    </div>
                    {{ end }}
                {{ end }}
            </div>
        </div>
    </div>
</div>

<style>
/* Sticky Controls */
.sticky-controls {
    position: sticky;
    top: 60px;
    z-index: 90;
    background: var(--bg-nav);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--border-primary);
    padding: 1rem 0;
    margin-bottom: 2rem;
}

.search-container {
    margin-bottom: 1rem;
}

.search-wrapper {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
}

.search-input {
    flex: 1;
    padding: 0.75rem 1rem;
}

.filter-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    white-space: nowrap;
}

/* Inline Filter Row */
.filter-row-inline {
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
}

.filter-group-inline {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex: 0 1 auto;
}

.filter-group-inline label {
    font-size: 0.875rem;
    color: var(--text-secondary);
    font-weight: 500;
    margin: 0;
}

.filter-select {
    padding: 0.5rem 0.75rem;
    background: var(--bg-card);
    border: 1px solid var(--border-card);
    border-radius: 6px;
    color: var(--text-primary);
    cursor: pointer;
    min-width: 120px;
    max-width: 200px;
}

.filter-select:focus {
    outline: none;
    border-color: var(--accent-primary);
}

.btn-reset {
    background: rgba(231, 76, 60, 0.2);
    border: 1px solid rgba(231, 76, 60, 0.4);
    color: #e74c3c;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-left: auto;
}

.btn-reset:hover {
    background: rgba(231, 76, 60, 0.3);
    border-color: rgba(231, 76, 60, 0.6);
}

/* View Toggle */
.view-toggle {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    background: var(--bg-card);
    border: 1px solid var(--border-card);
    padding: 0.25rem;
    border-radius: 8px;
    width: fit-content;
    margin: 0 auto;
}

.view-btn {
    padding: 0.5rem 1.5rem;
    background: transparent;
    border: none;
    border-radius: 6px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.95rem;
    font-weight: 500;
}

.view-btn:hover {
    background: var(--bg-button);
    color: var(--text-primary);
}

.view-btn.active {
    background: var(--accent-primary);
    color: #ffffff;
}

/* Enhanced TOC */
.toc {
    position: sticky;
    top: 180px;
    max-height: calc(100vh - 200px);
    overflow-y: auto;
}

.toc-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.toc-toggle {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 1.2rem;
    padding: 0.25rem;
    display: none;
}

.toc-link {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.625rem 0.75rem;
    transition: opacity 0.3s ease;
}

.toc-icon {
    font-size: 1rem;
}

.toc-dot {
    width: 0.75rem;
    height: 0.75rem;
    border-radius: 50%;
    flex-shrink: 0;
}

.toc-label {
    flex: 1;
}

.toc-count {
    font-size: 0.875rem;
    color: var(--text-tertiary);
    background: var(--bg-card);
    padding: 0.125rem 0.5rem;
    border-radius: 12px;
}

/* Quick Actions */
.quick-actions {
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border-card);
}

.quick-actions h4 {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin-bottom: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.quick-action-btn {
    width: 100%;
    text-align: left;
    padding: 0.625rem 0.75rem;
    background: transparent;
    border: none;
    border-radius: 6px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    margin-bottom: 0.25rem;
}

.quick-action-btn:hover {
    background: var(--bg-card);
    color: var(--text-primary);
}

/* Charts Grid */
.charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
    gap: 2rem;
    margin-top: 2rem;
}

.chart-card {
    background: var(--bg-card);
    border: 1px solid var(--border-card);
    border-radius: 8px;
    padding: 1.5rem;
}

.chart-card h3 {
    font-size: 1.1rem;
    color: var(--text-heading);
    margin-bottom: 1.5rem;
}

.chart-card canvas {
    max-height: 300px;
}

/* Section visibility based on view */
.content[data-view="statistics"] .papers-section,
.content[data-view="statistics"] .latest-additions-section {
    display: none;
}

.content[data-view="papers"] .statistics-section {
    display: none;
}

/* Latest Additions Section Highlight */
.latest-additions-section {
    background: var(--bg-section);
    border-left: 4px solid var(--accent-primary);
}

.latest-additions-section .section-title {
    color: var(--accent-primary);
}

/* Responsive */
@media (max-width: 1024px) {
    .toc-toggle {
        display: block;
    }
    
    .sticky-controls {
        top: 50px;
    }
    
    .toc {
        position: relative;
        top: 0;
        max-height: none;
    }
    
    .charts-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .filter-row-inline {
        flex-direction: column;
        align-items: stretch;
        gap: 0.75rem;
    }
    
    .filter-group-inline {
        width: 100%;
        flex-direction: column;
        align-items: stretch;
    }
    
    .filter-group-inline label {
        text-align: left;
    }
    
    .filter-select {
        width: 100%;
        max-width: none;
    }
    
    .btn-reset {
        margin-left: 0;
        width: 100%;
        justify-content: center;
    }
    
    .view-toggle {
        width: 100%;
    }
    
    .view-btn {
        flex: 1;
        justify-content: center;
    }
}
</style>

{{ end }}

{{ define "scripts" }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    let currentView = 'both';
    const stats = {{ site.Data.livingreview.stats | default dict | jsonify | safeJS }};

    // Get theme colors
    function getThemeColors() {
        const root = getComputedStyle(document.documentElement);
        const isDark = document.documentElement.getAttribute('data-theme') !== 'light';
        return {
            text: root.getPropertyValue('--text-primary').trim(),
            grid: root.getPropertyValue('--border-card').trim(),
            primary: '#6096ba',
            secondary: '#8bc4e8'
        };
    }

    let colors = getThemeColors();

    // Chart.js default config
    Chart.defaults.color = colors.text;
    Chart.defaults.borderColor = colors.grid;

    // Store chart instances for theme updates
    const chartInstances = {};

    // Chart 1: Publications per Year - Calculate from actual papers
    const ctx1 = document.getElementById('chart1');
    if (ctx1) {
        // Count papers by year and type (arXiv vs published)
        const yearData = {};
        
        document.querySelectorAll('.paper-item').forEach(paper => {
            const year = paper.dataset.year;
            const venue = (paper.dataset.venue || '').toLowerCase();
            
            if (year) {
                if (!yearData[year]) {
                    yearData[year] = { preprints: 0, published: 0 };
                }
                
                // Check if it's arXiv (preprint) or published
                if (venue.includes('arxiv')) {
                    yearData[year].preprints++;
                } else {
                    yearData[year].published++;
                }
            }
        });
        
        // Sort years and prepare data
        const years = Object.keys(yearData).sort();
        const preprintsData = years.map(y => yearData[y].preprints);
        const publishedData = years.map(y => yearData[y].published);
        
        console.log('Chart 1 - Publications by year:', yearData);
        
        chartInstances.chart1 = new Chart(ctx1, {
            type: 'line',
            data: {
                labels: years,
                datasets: [
                    {
                        label: 'Published Papers',
                        data: publishedData,
                        backgroundColor: colors.primary + '60',
                        borderColor: colors.primary,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Preprints',
                        data: preprintsData,
                        backgroundColor: colors.secondary + '60',
                        borderColor: colors.secondary,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { 
                        display: true,
                        labels: {
                            color: colors.text
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += context.parsed.y;
                                return label;
                            },
                            footer: function() {
                                return 'Calculated from actual paper venues';
                            }
                        }
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        grid: { color: colors.grid },
                        ticks: { color: colors.text },
                        stacked: false
                    },
                    x: { 
                        grid: { color: colors.grid },
                        ticks: { color: colors.text }
                    }
                }
            }
        });
    }

    // Chart 2: Papers by Category (Pie Chart) - Calculate from main categories
    const ctx2 = document.getElementById('chart2');
    if (ctx2) {
        // Count papers by main category (matching TOC categories)
        const mainCategoryCounts = {
            'Control': 0,
            'Optimization': 0,
            'Anomalies': 0,
            'Simulations': 0,
            'Novel Applications': 0,
            'Other Topics': 0
        };
        
        // Keywords for matching (same as used in paper grouping)
        const categoryKeywords = {
            'Control': ['Control', 'Controls', 'Feedback', 'Tuning', 'Operation', 'Operations'],
            'Optimization': ['Optimization', 'Optimisation', 'Parameter', 'Multi-Objective'],
            'Anomalies': ['Anomaly', 'Fault', 'Error', 'Beam Loss', 'Loss'],
            'Simulations': ['Simulation', 'Surrogate', 'Virtual', 'Digital Twin', 'Modeling', 'Modelling'],
            'Novel Applications': ['Novel', 'Emerging', 'Advanced', 'New Techniques']
        };
        
        document.querySelectorAll('.paper-item').forEach(paper => {
            const allCats = (paper.dataset.allCategories || '').toLowerCase();
            let categorized = false;
            
            // Check which main category this paper belongs to
            for (const [mainCat, keywords] of Object.entries(categoryKeywords)) {
                for (const keyword of keywords) {
                    if (allCats.includes(keyword.toLowerCase())) {
                        mainCategoryCounts[mainCat]++;
                        categorized = true;
                        break;
                    }
                }
                if (categorized) break;
            }
            
            // If not categorized and not a special category (tools/facility), put in Other
            if (!categorized) {
                const isSpecial = allCats.includes('tool') || allCats.includes('method') || 
                                 allCats.includes('facility') || allCats.includes('review');
                if (!isSpecial) {
                    mainCategoryCounts['Other Topics']++;
                }
            }
        });
        
        console.log('Chart 2 - Papers by main category:', mainCategoryCounts);
        
        const categoryColors = ['#6096ba', '#507a9a', '#8bc4e8', '#4a6fa5', '#2e5266', '#7aa8c0'];
        
        chartInstances.chart2 = new Chart(ctx2, {
            type: 'pie',
            data: {
                labels: Object.keys(mainCategoryCounts),
                datasets: [{
                    data: Object.values(mainCategoryCounts),
                    backgroundColor: categoryColors,
                    borderWidth: 2,
                    borderColor: colors.grid
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { position: 'right' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    // Chart 3: Recent Activity (Bar Chart)
    const ctx3 = document.getElementById('chart3');
    if (ctx3) {
        const monthlyData = stats.monthly_trends || {};
        const months = Object.keys(monthlyData).slice(-6);
        chartInstances.chart3 = new Chart(ctx3, {
            type: 'bar',
            data: {
                labels: months,
                datasets: [{
                    label: 'Publications',
                    data: months.map(m => monthlyData[m]),
                    backgroundColor: colors.primary,
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: { beginAtZero: true, grid: { color: colors.grid } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    // Chart 4: Top Venues (Horizontal Bar)
    const ctx4 = document.getElementById('chart4');
    if (ctx4) {
        const venues = stats["per_venue/journal"] || {};
        const sortedVenues = Object.entries(venues).sort((a,b) => b[1] - a[1]).slice(0, 5);
        chartInstances.chart4 = new Chart(ctx4, {
            type: 'bar',
            data: {
                labels: sortedVenues.map(v => v[0]),
                datasets: [{
                    label: 'Papers',
                    data: sortedVenues.map(v => v[1]),
                    backgroundColor: colors.primary,
                    borderRadius: 6
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    x: { beginAtZero: true, grid: { color: colors.grid } },
                    y: { grid: { display: false } }
                }
            }
        });
    }

    // Section toggle
    window.toggleSection = function(header) {
        header.parentElement.classList.toggle('collapsed');
    };

    // View switching
    window.setView = function(view) {
        currentView = view;
        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.view === view);
        });
        
        const content = document.getElementById('mainContent');
        content.setAttribute('data-view', view);
        
        if (view === 'statistics') {
            document.getElementById('statistics')?.classList.remove('collapsed');
        } else if (view === 'papers') {
            document.querySelectorAll('.papers-section').forEach(s => s.classList.remove('collapsed'));
        }
    };

    // Reset filters
    window.resetFilters = function() {
        document.getElementById('searchInput').value = '';
        document.getElementById('yearFilter').value = '';
        document.getElementById('venueFilter').value = '';
        document.getElementById('specialFilter').value = '';
        applyFilters();
    };

    // Apply filters
    function applyFilters() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const yearFilter = document.getElementById('yearFilter').value;
        const venueFilter = document.getElementById('venueFilter').value.toLowerCase();
        const specialFilter = document.getElementById('specialFilter').value;
        
        // Initialize category counts
        const categoryCounts = {
            'control': 0,
            'optimization': 0,
            'anomalies': 0,
            'simulations': 0,
            'novel-applications': 0,
            'other-topics': 0
        };
        
        // Count visible papers
        document.querySelectorAll('.paper-item').forEach(paper => {
            const title = (paper.dataset.title || '').toLowerCase();
            const authors = (paper.dataset.authors || '').toLowerCase();
            const year = paper.dataset.year || '';
            const venue = (paper.dataset.venue || '').toLowerCase();
            const mainCategory = paper.dataset.mainCategory || '';
            const allCategories = (paper.dataset.allCategories || '').toLowerCase();
            
            const matchSearch = !searchTerm || title.includes(searchTerm) || authors.includes(searchTerm);
            const matchYear = !yearFilter || year === yearFilter;
            const matchVenue = !venueFilter || venue.includes(venueFilter);
            const matchSpecial = !specialFilter || allCategories.includes(specialFilter.toLowerCase());
            
            const isVisible = matchSearch && matchYear && matchVenue && matchSpecial;
            paper.style.display = isVisible ? 'block' : 'none';
            
            // Count visible papers by main category
            if (isVisible && mainCategory && categoryCounts.hasOwnProperty(mainCategory)) {
                categoryCounts[mainCategory]++;
            }
        });
        
        // Update TOC counts
        document.querySelectorAll('.toc-link').forEach(link => {
            const category = link.dataset.category;
            const countBadge = link.querySelector('.toc-count');
            
            if (countBadge && category && category !== 'statistics') {
                const count = categoryCounts[category] || 0;
                countBadge.textContent = count;
                link.style.opacity = count === 0 ? '0.5' : '1';
            }
        });
        
        // Hide sections with no visible papers
        document.querySelectorAll('.papers-section').forEach(section => {
            const visiblePapers = section.querySelectorAll('.paper-item[style*="display: block"]');
            section.style.display = visiblePapers.length > 0 ? 'block' : 'none';
        });
    }

    document.getElementById('searchInput')?.addEventListener('input', applyFilters);
    document.getElementById('yearFilter')?.addEventListener('change', applyFilters);
    document.getElementById('venueFilter')?.addEventListener('change', applyFilters);
    document.getElementById('specialFilter')?.addEventListener('change', applyFilters);
    
    // Initialize counts on page load - wait for DOM to be fully ready
    window.addEventListener('load', function() {
        console.log('Initializing paper counts...');
        console.log('Total papers found:', document.querySelectorAll('.paper-item').length);
        applyFilters();
    });
    
    // Also try immediately
    applyFilters();

    // Watch for theme changes and update charts
    function updateChartsTheme() {
        colors = getThemeColors();
        
        // Update Chart.js defaults
        Chart.defaults.color = colors.text;
        Chart.defaults.borderColor = colors.grid;
        
        // Update each chart
        Object.values(chartInstances).forEach(chart => {
            if (chart && chart.options) {
                // Update scales colors
                if (chart.options.scales) {
                    if (chart.options.scales.x) {
                        chart.options.scales.x.grid = chart.options.scales.x.grid || {};
                        chart.options.scales.x.grid.color = colors.grid;
                        chart.options.scales.x.ticks = chart.options.scales.x.ticks || {};
                        chart.options.scales.x.ticks.color = colors.text;
                    }
                    if (chart.options.scales.y) {
                        chart.options.scales.y.grid = chart.options.scales.y.grid || {};
                        chart.options.scales.y.grid.color = colors.grid;
                        chart.options.scales.y.ticks = chart.options.scales.y.ticks || {};
                        chart.options.scales.y.ticks.color = colors.text;
                    }
                }
                
                // Update legend color
                if (chart.options.plugins && chart.options.plugins.legend) {
                    chart.options.plugins.legend.labels = chart.options.plugins.legend.labels || {};
                    chart.options.plugins.legend.labels.color = colors.text;
                }
                
                // Update the chart
                chart.update('none'); // 'none' mode for instant update without animation
            }
        });
        
        console.log('Charts theme updated to:', document.documentElement.getAttribute('data-theme'));
    }
    
    // Observe theme changes
    const themeObserver = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.attributeName === 'data-theme') {
                updateChartsTheme();
            }
        });
    });
    
    // Start observing
    themeObserver.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['data-theme']
    });

    // TOC active state
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const id = entry.target.id;
                document.querySelectorAll('.toc-link').forEach(link => {
                    link.classList.toggle('active', link.dataset.category === id);
                });
            }
        });
    }, { threshold: 0.5, rootMargin: '-20% 0px -60% 0px' });

    document.querySelectorAll('.section').forEach(section => observer.observe(section));

    // Quick Actions
    window.showAllPapers = function() {
        document.querySelectorAll('.papers-section').forEach(s => s.classList.remove('collapsed'));
        setView('papers');
        resetFilters();
    };

    // window.showRecentAdditions = function() {
    //     alert('Showing papers from the last 30 days');
    // };
    // Quick Action: Scroll to "Latest Additions" section
    window.showRecentAdditions = function() {
    // Switch to "papers" view so the section is visible
    setView('papers');

    const latestSection = document.getElementById('latest-additions');
    if (latestSection) {
        // Expand if collapsed
        latestSection.classList.remove('collapsed');

        // Smooth scroll to the section
        latestSection.scrollIntoView({
        behavior: 'smooth',
        block: 'start'
        });

        // Optional: visual highlight pulse for clarity
        latestSection.style.transition = 'box-shadow 0.4s ease';
        latestSection.style.boxShadow = '0 0 0 4px var(--accent-primary)';
        setTimeout(() => {
        latestSection.style.boxShadow = 'none';
        }, 1500);
    }
    };

    window.exportBibliography = function() {
        let bibtex = '';
        document.querySelectorAll('.paper-item:not([style*="display: none"])').forEach((paper, i) => {
            const title = paper.dataset.title;
            const authors = paper.dataset.authors;
            const year = paper.dataset.year;
            bibtex += `@article{paper${i+1},\n  title={${title}},\n  author={${authors}},\n  year={${year}}\n}\n\n`;
        });
        
        const blob = new Blob([bibtex], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'living_review_bibliography.bib';
        a.click();
        URL.revokeObjectURL(url);
    };

    window.toggleTOC = function() {
        document.getElementById('tocSidebar').classList.toggle('collapsed');
    };
});
</script>
{{ end }}